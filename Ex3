import csv
from datetime import datetime

class BatchProcessor:
    def __init__(self, csv_file, log_file="journal.log"):
        self.csv_file = csv_file
        self.log_file = log_file

    def __enter__(self):
        self.f_csv = open(self.csv_file, "r", newline="")
        self.f_log = open(self.log_file, "a")
        self.reader = csv.reader(self.f_csv)
        self.f_log.write(f"[{datetime.now()}] Debut du traitement du fichier {self.csv_file}\n")
        return self

    def __exit__(self, exc_type, exc_value, traceback):
        self.f_log.write(f"[{datetime.now()}] Fin du traitement du fichier {self.csv_file}\n")
        if exc_type:
            self.f_log.write(f"[{datetime.now()}] Erreur : {exc_type.__name__} — {exc_value}\n")
        self.f_csv.close()
        self.f_log.close()

    def run(self):
        for line in self.reader:
            self.f_log.write(f"[{datetime.now()}] Traitement de : {line}\n")
            print("Traitement :", line)
            if "ERROR" in line:
                raise ValueError("Erreur simulee dans les données")

with BatchProcessor("operations.csv") as bp:
    bp.run()
